= Hosting a Tor Relay on Windows
:published_at: 2017-03-27
:hp-tags: tor, relay, windows, how to, privacy, vps
:hp-alt-title: tor-relay-on-windows

Do you have an unused VPS or credit for a cloud computing platform?  Do you want to help [promote freedom and privacy](https://www.torproject.org/about/torusers.html.en) while fighting [censorship](https://trac.torproject.org/projects/tor/wiki/doc/OONI/censorshipwiki)?  Consider running a Tor Relay to help sustain the [Tor Project](https://www.torproject.org)!\n\nIn my case, I have some Azure credits ([`$150 per month`, from Visual Studio Ultimate with MSDN](https://azure.microsoft.com/en-us/offers/ms-azr-0049p/)) I want to spend on hosting a Tor non-exit relay.  I had a Windows VM laying around and wanted to reuse that.  (If you're starting from scratch, I would recommend some flavor of Unix/Linux - there is [much more documentation](https://www.torproject.org/docs/tor-relay-debian.html.en) for that platform!)  I couldn't find updated instructions for how to do this on Windows, since most of the documented techniques have been invalidated or replaced!  I'm documenting my findings to try and help save you some trouble!\n\nDon't worry - setting this up isn't too difficult!\n\n# Concerns with running a relay\n\n> \"I'd run a relay, but I don't want to deal with abuse issues.\"\n\nGood news!  [You can specify an exit policy](https://www.torproject.org/docs/faq.html.en#ExitPolicies) for your relay, so it can refuse to allow Tor clients to exit through your node!  You can help the Tor network sustain its load (since all clients route through 3 relays) without worrying about abuse!  However, if you *really* want to run an exit relay, I highly recommend reading the [Abuse FAQ](https://www.torproject.org/docs/faq-abuse.html.en#TypicalAbuses) and Mike Perry's [Tips for Running an Exit Node (with minimal harassment)](https://blog.torproject.org/blog/tips-running-exit-node).\n\n[Someone asked a question on MSDN](https://social.msdn.microsoft.com/Forums/en-US/d8c924e6-6dac-430b-a100-a11162229b52/tor-on-a-vm) about whether it's okay to host a Tor exit node on an Azure VM, and seemed to get a fairly positive reply.  My own attempts at asking support for confirmation never produced a firm answer.  I would recommend you [do a bit of research online](https://trac.torproject.org/projects/tor/wiki/doc/GoodBadISPs) to see if your VPS provider (or ISP) has a good relationship with the Tor community.\n\n# Set up\n\nFirst, I want to highlight that I don't see a need for a particularly beefy server.  My Azure VM size is `Basic A1 (1 Core, 1.75 GB memory)`, which costs `$23.06 per month` in my region.  My CPU usage averages below 5% and my memory usage hovers around 1 GB, with only about 75 MB of that coming from `tor.exe`!  Hard drive use is minimal as well.  The main restriction will be bandwidth, which we will touch on later.\n\nDo you have your VPS provisioned?  Ready to go?  Then let's get started!\n\n1. Head over to the [Tor download page](https://www.torproject.org/download/download.html.en) and download the `Expert Bundle`.\n2. Extract the .zip file somewhere safe.  I just dropped it in my `C:\\` directly.\n3. Add a shortcut for the extracted `tor.exe` to your startup folder (`C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\Startup`) if you would like it to start on login!\n4. Create a `torrc` file with no file extension under `C:\\Users\\usernamehere\\AppData\\Roaming\\tor`, then open it with your favorite text editor!\n5. After we finish customizing these options, run your `tor.exe`!\n\n## Recommended `torrc` options\n\nThese are what I consider to be essential.  Each of these options should be a separate line in your `torrc` file.  Use `#` for comments.  Read the [sample torrc file](https://gitweb.torproject.org/tor.git/plain/src/config/torrc.sample.in) for more information on these options.\n\n* `SOCKSPort 0` - indicates you plan to run Tor only as a relay, and not make any local application connections yourself.\n* `ORPort 9001` - which port to advertise for incoming Tor connections.  Usually 9001.\n* `Address noname.example.com` - specify an IP address or full DNS name for your relay.\n * If you don't specify this, Tor will guess.  Tor appears to cache this guess, because it kept trying to use my old IP address after I restarted my VPS and was issued a new public IP.  So I recommend explicitly specifying this.\n* `Nickname ididnteditheconfig` - a human-readable handle for your relay\n* `ContactInfo 0xFFFFFFFF Random Person <nobody AT example dot com>` - *optional* administrative contact information.\n * This will be public and probably indexed by Google and spammers.\n * You can include your PGP fingerprint and obscured email address if you want.\n* `ExitPolicy reject *:*` - no exits allowed.  This one is important!\n * Use this recommendation unless you *absolutely* know what you're signing up for!\n\n## Ports\n\nYou need to make sure port `9001` is properly open so Tor clients can reach you!\n\n* Make sure your incoming and outgoing rules on Windows Firewall grant exceptions for this port.\n * I saw some weird failure with only allowing TCP, so I also allowed UDP.\n* In your VPS portal, set up port forwarding.\n * In Azure, this is handled under the 'Endpoints' menu.\n * Again, I did TCP *and* UDP to avoid some issue.\n* If you want to enable directory mirroring, you'll need to do this for port `9030` as well.\n * I personally don't recommend doing this if you have limited bandwidth to provide.\n\nYou can use a [port checker](http://ismyportopen.com/) to verify if your ports are opened properly.\n\n## Logging\n\nAdd this line, which specifies your own .log location, to your `torrc` file to enable `[notice]` level logging.\n\n`Log notice file C:\\tor-win32-0.2.9.10\\log\\tor\\notices.log `\n\nI recommend setting up this logging so you can track important changes (like `ORPort` success confirmation, bandwidth limit updates, etc.)!  For the record, my `tor.exe` crashed on launch until I manually created the directory for my logs.\n\nIf you have any problems or want to verify everything's working properly, open this file in your text editor and read the last few lines!\n\n## Limiting bandwidth usage\n\n[Bandwidth shaping and limiting](https://www.torproject.org/docs/faq.html.en#BandwidthShaping) is covered in good detail on the FAQ.  I'm personally using the `AccountingStart`, `AccountingMax`, and `AccountingRule` options in my `torrc` file to specify how much bandwidth I think I can afford (without running out of credits) and when my billing cycle resets.  You can read more about these options in the [tor man page](https://www.torproject.org/docs/tor-manual.html.en).\n\n```\nAccountingRule out # we only pay for data leaving Azure, so only track that\nAccountingMax 1000 GBytes\nAccountingStart month 12 00:00 # my billing cycle resets on the 12th of each month\n```\n\nCheck your VPS providers pricing to try and determine how much bandwidth you can afford!  For example, [Azure only charges for outbound data](https://azure.microsoft.com/en-us/pricing/details/bandwidth/) - but the price depends on the destination.  I recommend checking your VPS portal occasionally at first to make sure your usage is in check.\n\nIn my case, I have `($150 - $23.06) = $126.94` (if I ignore the < $2 cost of storage for my VM's hard drive) which I can spend on outbound bandwidth.  If I pretend my outbound traffic is split evenly among Azure's zones (**spoiler**: it won't be - the most expensive region, Brazil South, is probably not as common of a destination as the other, cheaper regions), then I can afford `1000 GB` at a price of `$126.53`!\n\nI'll fine tune this number as I learn rough trends in data routing, so hopefully I can increase the limit to some nice round number... like `1024 GB`!\n\n## Run it!\n\nRun that `tor.exe` and monitor your logs!  Ideally, after some key generation, you should see some logs like below - indicating your new relay is up and running!\n\n```\nYour Tor server's identity key fingerprint is 'rororelay 1821A0D2FF5B309A4FD3E8FC654773FC0927779F'\nBootstrapped 100%: Done\nNow checking whether ORPort 9001 is reachable...\nSelf-testing indicates your ORPort is reachable from the outside. Excellent. Publishing server descriptor.\nPerforming bandwidth self-test...done.\n```\n\nCongratulations, your relay works!  I highly recommend reading this blog post explaining [The lifecycle of a new relay](https://blog.torproject.org/blog/lifecycle-of-a-new-relay).\n\nTry searching for your relay on [Atlas](https://atlas.torproject.org/) using its nickname or fingerprint!  You should be able to see it running, and in time Atlas will graph relevant data!  Note that Atlas caches information, so it might take an hour or two to update.\n\n\n\n# Additional links\n\n[My full `torrc` configuration file](https://github.com/rorosaurus/rororelay) is on GitHub if you're looking for a full example.  I also highly recommend checking out the [sample torrc file](https://gitweb.torproject.org/tor.git/plain/src/config/torrc.sample.in) and the [tor man page](https://www.torproject.org/docs/tor-manual.html.en) for more options, as mentioned in the [official relay configuration manual](https://www.torproject.org/docs/tor-doc-relay.html.en)!\n\nYou can [view stats and data about my relay, rororelay, on Atlas](https://atlas.torproject.org/#details/1821A0D2FF5B309A4FD3E8FC654773FC0927779F)!\n\n* [How to Run a Secure Tor Server](https://trac.torproject.org/projects/tor/wiki/doc/OperationalSecurity)\n* [How to back up your private key](https://www.torproject.org/docs/faq.html.en#UpgradeOrMove)\n* [Why does directory mirroring get disabled when AccountingMax is on?](https://tor.stackexchange.com/questions/3271/why-does-directory-mirroring-get-disabled-when-accountingmax-is-on)\n